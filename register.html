<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>إنشاء حساب</title>

  <link rel="icon" type="image/png" href="images/ofouq-logo.jpeg" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Tajawal',sans-serif;
      min-height:100vh;
      display:flex;justify-content:center;align-items:center;
      padding:20px;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(10,162,202,.20), transparent 55%),
                  radial-gradient(900px 500px at 90% 90%, rgba(34,197,94,.18), transparent 55%),
                  linear-gradient(135deg,#f5f7fb 0%,#e2e8f0 100%);
      overflow:hidden;
    }
    .dot{position:fixed;width:10px;height:10px;border-radius:999px;background:rgba(10,162,202,.25);z-index:-1;animation:drift 10s linear infinite}
    .dot:nth-child(1){top:10%;left:8%;animation-duration:12s}
    .dot:nth-child(2){top:20%;left:90%;animation-duration:14s;background:rgba(34,197,94,.22)}
    .dot:nth-child(3){top:75%;left:10%;animation-duration:16s}
    .dot:nth-child(4){top:85%;left:80%;animation-duration:18s;background:rgba(34,197,94,.20)}
    @keyframes drift{0%{transform:translate(0,0) scale(1);opacity:.6}50%{transform:translate(30px,-20px) scale(1.15);opacity:.35}100%{transform:translate(0,0) scale(1);opacity:.6}}

    .container{
      width:100%;
      max-width:420px;
      background:rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border:1px solid rgba(148,163,184,.25);
      border-radius:22px;
      padding:28px;
      box-shadow: 0 18px 55px rgba(2, 6, 23, .12);
      position:relative;
      overflow:hidden;
      transform:translateY(12px);
      opacity:0;
      animation:popIn .55s cubic-bezier(.2,.9,.2,1) forwards;
      text-align:center;
    }
    @keyframes popIn{from{opacity:0;transform:translateY(18px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#0aa2ca,#078fa8)}
    .container::after{
      content:'';
      position:absolute;
      top:-60px; left:-90px;
      width:140px; height:220px;
      transform: rotate(25deg);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: shine 3.6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shine{0%,50%{transform:translateX(-40px) rotate(25deg);opacity:0}55%{opacity:1}100%{transform:translateX(560px) rotate(25deg);opacity:0}}

    h2{margin:6px 0 8px;color:#0a4f5f;font-weight:800;font-size:26px}
    .subtitle{margin-bottom:16px;color:#64748b;font-size:13px;line-height:1.7}

    .message{display:none;margin-bottom:14px;padding:12px 16px;font-size:14px;border-radius:12px;font-weight:600;text-align:right}
    .message.success{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border-right:4px solid #34d399}
    .message.error{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border-right:4px solid #f87171}

    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:8px}
    .input-box{position:relative}
    .base-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:18px;color:#94a3b8;pointer-events:none;transition:.18s}
    .input-box input{
      width:100%;
      padding:14px 92px 14px 50px;
      border:2px solid #e5e7eb;border-radius:25px;background:#f8fafc;outline:none;
      font-family:'Tajawal',sans-serif;font-size:15px;transition:.2s;
    }
    .input-box input:focus{border-color:#0aa2ca;background:#fff;box-shadow:0 0 0 4px rgba(10,162,202,.12)}
    .input-box input:focus ~ .base-icon{color:#0aa2ca}

    .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px;align-items:center}
    .icon-btn{width:32px;height:32px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;color:#64748b;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.15s}
    .icon-btn:hover{transform:translateY(-1px);border-color:#cbd5e1}
    .icon-btn:active{transform:translateY(0) scale(.98)}

    .state-icon{width:32px;height:32px;border-radius:999px;display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(.88);transition:.18s;border:1px solid transparent}
    .input-box.valid .state-icon{opacity:1;background:rgba(16,185,129,.12);color:#10b981;border-color:rgba(16,185,129,.18);transform:scale(1)}
    .input-box.invalid .state-icon{opacity:1;background:rgba(239,68,68,.12);color:#ef4444;border-color:rgba(239,68,68,.18);transform:scale(1)}

    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(6px)}40%{transform:translateX(-6px)}60%{transform:translateX(4px)}80%{transform:translateX(-4px)}}
    .input-error{border-color:#ef4444 !important;animation:shake .28s ease;background:#fff}

    button{
      width:100%;
      padding:14px;
      border:none;
      border-radius:25px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      font-family:'Tajawal',sans-serif;
      transition:.2s;
      position:relative;
      overflow:hidden;
    }
    .ripple{position:absolute;border-radius:50%;transform:scale(0);animation:ripple .55s linear;background:rgba(255,255,255,.55);pointer-events:none}
    @keyframes ripple{to{transform:scale(3.2);opacity:0}}

    .primary{background:linear-gradient(135deg,#0aa2ca,#078fa8);color:#fff;box-shadow:0 10px 30px rgba(10,162,202,.22)}
    .primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 16px 40px rgba(10,162,202,.28)}
    .primary:disabled{opacity:.65;cursor:not-allowed;transform:none}

    .divider{margin:16px 0 12px;color:#94a3b8;font-size:14px;position:relative}
    .divider::before{content:'';position:absolute;top:50%;right:calc(50% + 16px);left:calc(50% - 16px);height:1px;background:#e5e7eb}

    .google-wrap{display:flex;justify-content:center;margin-bottom:10px}

    .ghost{background:#f1f5f9;color:#0f172a;border:2px solid #e2e8f0;font-weight:800}
    .ghost:hover{background:#e2e8f0;transform:translateY(-1px)}

    @media(max-width:480px){
      body{padding:10px}
      .container{padding:22px}
      .input-box input{padding:12px 86px 12px 45px;font-size:14px}
    }
  </style>
</head>

<body>
  <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>

  <div class="container">
    <h2>إنشاء حساب</h2>
    <div class="subtitle">املأ البيانات أو أنشئ حسابك باستخدام Google.</div>

    <div id="msg" class="message"></div>

    <div class="grid">
      <!-- ONE name field only -->
      <div class="input-box" id="nameBox">
        <i class="ri-user-3-line base-icon"></i>
        <input id="fullName" type="text" placeholder="الاسم الكامل" autocomplete="name" required>
        <div class="actions"><span class="state-icon"></span></div>
      </div>

      <div class="input-box" id="emailBox">
        <i class="ri-at-line base-icon"></i>
        <input id="email" type="email" placeholder="البريد الإلكتروني" autocomplete="email" required>
        <div class="actions"><span class="state-icon"></span></div>
      </div>

      <div class="input-box" id="passBox">
        <i class="ri-lock-password-line base-icon"></i>
        <input id="password" type="password" placeholder="كلمة المرور (6+)" autocomplete="new-password" required>
        <div class="actions">
          <button class="icon-btn" id="togglePass" type="button" aria-label="إظهار كلمة المرور">
            <i class="ri-eye-line"></i>
          </button>
          <span class="state-icon"></span>
        </div>
      </div>

      <div class="input-box" id="confirmBox">
        <i class="ri-lock-line base-icon"></i>
        <input id="confirm" type="password" placeholder="تأكيد كلمة المرور" autocomplete="new-password" required>
        <div class="actions">
          <button class="icon-btn" id="toggleConfirm" type="button" aria-label="إظهار كلمة المرور">
            <i class="ri-eye-line"></i>
          </button>
          <span class="state-icon"></span>
        </div>
      </div>
    </div>

    <button class="primary" id="registerBtn" onclick="registerLocal(event)">
      <span id="regText">إنشاء حساب</span>
      <span id="regSpinner" style="display:none;">⏳ جاري...</span>
    </button>

    <div class="divider">أو</div>

    <div class="google-wrap">
      <div id="googleBtn"></div>
    </div>

    <button class="ghost" type="button" onclick="location.href='login.html'">
      <i class="ri-login-circle-line"></i> لدي حساب بالفعل
    </button>
  </div>

<script>
  // Ripple
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    const rect = btn.getBoundingClientRect();
    const r = document.createElement('span');
    r.className = 'ripple';
    const size = Math.max(rect.width, rect.height);
    r.style.width = r.style.height = size + 'px';
    r.style.left = (e.clientX - rect.left - size/2) + 'px';
    r.style.top  = (e.clientY - rect.top  - size/2) + 'px';
    btn.appendChild(r);
    setTimeout(() => r.remove(), 600);
  });

  function showMsg(text, type='success'){
    const msg = document.getElementById('msg');
    msg.className = 'message ' + type;
    msg.textContent = text;
    msg.style.display = 'block';
    if(type === 'success') setTimeout(() => msg.style.display = 'none', 2500);
  }

  function setLoading(v){
    document.getElementById('registerBtn').disabled = v;
    document.getElementById('regText').style.display = v ? 'none' : 'inline';
    document.getElementById('regSpinner').style.display = v ? 'inline' : 'none';
  }

  function setFieldState(boxId, state){
    const box = document.getElementById(boxId);
    const stateEl = box.querySelector('.state-icon');
    box.classList.remove('valid','invalid');

    if(state === 'valid'){ box.classList.add('valid'); stateEl.innerHTML = '<i class="ri-check-line"></i>'; }
    else if(state === 'invalid'){ box.classList.add('invalid'); stateEl.innerHTML = '<i class="ri-close-line"></i>'; }
    else { stateEl.innerHTML = ''; }
  }

  function markError(id){
    const el = document.getElementById(id);
    el.classList.remove('input-error');
    void el.offsetWidth;
    el.classList.add('input-error');
    setTimeout(() => el.classList.remove('input-error'), 350);
  }

  const fullNameEl = document.getElementById('fullName');
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const confirmEl = document.getElementById('confirm');

  fullNameEl.addEventListener('input', () => {
    const v = fullNameEl.value.trim();
    if(!v) return setFieldState('nameBox','none');
    setFieldState('nameBox', v.length >= 3 ? 'valid' : 'invalid');
  });

  emailEl.addEventListener('input', () => {
    const v = emailEl.value.trim();
    if(!v) return setFieldState('emailBox','none');
    setFieldState('emailBox', /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v) ? 'valid' : 'invalid');
  });

  function validatePasswords(){
    const p = passEl.value;
    const c = confirmEl.value;
    if(!p) setFieldState('passBox','none'); else setFieldState('passBox', p.length >= 6 ? 'valid':'invalid');
    if(!c) setFieldState('confirmBox','none'); else setFieldState('confirmBox', (c === p && c.length >= 6) ? 'valid':'invalid');
  }
  passEl.addEventListener('input', validatePasswords);
  confirmEl.addEventListener('input', validatePasswords);

  document.getElementById('togglePass').addEventListener('click', () => {
    const isPass = passEl.type === 'password';
    passEl.type = isPass ? 'text' : 'password';
    document.getElementById('togglePass').innerHTML = isPass ? '<i class="ri-eye-off-line"></i>' : '<i class="ri-eye-line"></i>';
    passEl.focus();
  });
  document.getElementById('toggleConfirm').addEventListener('click', () => {
    const isPass = confirmEl.type === 'password';
    confirmEl.type = isPass ? 'text' : 'password';
    document.getElementById('toggleConfirm').innerHTML = isPass ? '<i class="ri-eye-off-line"></i>' : '<i class="ri-eye-line"></i>';
    confirmEl.focus();
  });

  // Local register
  function registerLocal(ev){
    if(ev) ev.preventDefault();

    const fullName = fullNameEl.value.trim();
    const email = emailEl.value.trim();
    const password = passEl.value;
    const confirm = confirmEl.value;

    if(!fullName){ markError('fullName'); return showMsg('أدخل الاسم الكامل', 'error'); }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ markError('email'); return showMsg('بريد إلكتروني غير صحيح', 'error'); }
    if(password.length < 6){ markError('password'); return showMsg('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error'); }
    if(confirm !== password){ markError('confirm'); return showMsg('تأكيد كلمة المرور غير مطابق', 'error'); }

    setLoading(true);

    let users = [];
    try{ users = JSON.parse(localStorage.getItem('users') || '[]'); }catch(e){ users = []; }

    if(users.some(u => (u.email || '').toLowerCase() === email.toLowerCase())){
      setLoading(false);
      return showMsg('البريد الإلكتروني مستخدم بالفعل', 'error');
    }

    const newUser = {
      id: Date.now(),
      fullName,
      email,
      password,
      provider: 'local'
    };

    users.push(newUser);
    localStorage.setItem('users', JSON.stringify(users));

    // auto login after register
    localStorage.setItem('user', JSON.stringify({
      provider:'local',
      loggedIn:true,
      id: newUser.id,
      name: newUser.fullName,
      email: newUser.email,
      lastLogin: Date.now()
    }));

    setLoading(false);
    showMsg('✅ تم إنشاء الحساب بنجاح', 'success');

    setTimeout(() => {
      const fromPage = sessionStorage.getItem('loginFrom') || 'index.html';
      window.location.href = fromPage;
    }, 700);
  }

  // Google Sign-Up: response.credential is a JWT ID token. [page:4]
  function decodeJwtPayload(token){
    const part = token.split('.')[1];
    const base64 = part.replace(/-/g,'+').replace(/_/g,'/');
    const json = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(json);
  }

  function onGoogleCredential(response){
    try{
      const idToken = response && response.credential; // JWT [page:4]
      if(!idToken) return showMsg('تعذر استلام بيانات Google', 'error');

      const p = decodeJwtPayload(idToken);

      // Store in users[] (optional)
      let users = [];
      try{ users = JSON.parse(localStorage.getItem('users') || '[]'); }catch(e){ users = []; }
      const email = (p.email || '').toLowerCase();

      if(email && !users.some(u => (u.email || '').toLowerCase() === email)){
        users.push({
          id: Date.now(),
          fullName: p.name || '',
          email: p.email || '',
          provider: 'google'
        });
        localStorage.setItem('users', JSON.stringify(users));
      }

      // logged-in user
      localStorage.setItem('user', JSON.stringify({
        provider:'google',
        loggedIn:true,
        id: p.sub || Date.now(),
        name: p.name || '',
        email: p.email || '',
        picture: p.picture || '',
        idToken,
        lastLogin: Date.now()
      }));

      const fromPage = sessionStorage.getItem('loginFrom') || 'index.html';
      window.location.assign(new URL(fromPage, window.location.origin).toString());
    } catch(e){
      showMsg('حدث خطأ أثناء إنشاء الحساب عبر Google', 'error');
    }
  }

  window.addEventListener('load', () => {
    if(!window.google || !google.accounts || !google.accounts.id){
      return showMsg('Google library لم تُحمّل. تأكد من الإنترنت', 'error');
    }

    google.accounts.id.initialize({
      client_id: "169941841275-n5h6h3bqa3ck0lll8dgd194uqb68b5jv.apps.googleusercontent.com",
      callback: onGoogleCredential,
      ux_mode: "popup"
    }); // initialize + callback [page:4]

    google.accounts.id.renderButton(
      document.getElementById("googleBtn"),
      { theme: "outline", size: "large", shape: "pill", text: "signup_with" }
    ); // renderButton [page:4]
  });

  document.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') registerLocal();
  });
</script>
</body>
</html>
