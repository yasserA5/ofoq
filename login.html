<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>تسجيل الدخول</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="https://accounts.google.com/gsi/client" async defer></script> <!-- GIS [page:2] -->

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Tajawal',sans-serif;background:linear-gradient(135deg,#f5f7fb 0%,#e2e8f0 100%);display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
    .container{width:100%;max-width:380px;background:#fff;padding:28px;border-radius:22px;box-shadow:0 10px 35px rgba(0,0,0,.12);text-align:center;position:relative;overflow:hidden}
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#0aa2ca,#078fa8)}
    h2{margin:8px 0 16px;color:#0a4f5f}
    .message{display:none;margin-bottom:14px;padding:12px 16px;font-size:14px;border-radius:12px;font-weight:500;text-align:right}
    .message.success{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border-right:4px solid #34d399}
    .message.error{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border-right:4px solid #f87171}
    .input-box{position:relative;margin-bottom:14px}
    .base-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#9ca3af}
    .actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px;align-items:center}
    .icon-btn{width:32px;height:32px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;color:#6b7280;cursor:pointer}
    .state-icon{width:32px;height:32px;border-radius:999px;display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(.88);transition:.18s;border:1px solid transparent}
    .input-box input{width:100%;padding:14px 92px 14px 50px;border:2px solid #e5e7eb;border-radius:25px;background:#fafafa;outline:none;font-family:'Tajawal',sans-serif}
    .input-box.valid .state-icon{opacity:1;background:rgba(16,185,129,.12);color:#10b981;border-color:rgba(16,185,129,.18);transform:scale(1)}
    .input-box.invalid .state-icon{opacity:1;background:rgba(239,68,68,.12);color:#ef4444;border-color:rgba(239,68,68,.18);transform:scale(1)}
    .options{display:flex;justify-content:space-between;align-items:center;margin:10px 0 16px;font-size:14px;color:#6b7280;gap:10px}
    .options a{color:#0aa2ca;text-decoration:none}
    button.main{width:100%;padding:14px;border:none;border-radius:25px;font-size:16px;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;background:linear-gradient(135deg,#0aa2ca,#078fa8);color:#fff}
    button.main:disabled{opacity:.65;cursor:not-allowed}
    .divider{margin:16px 0 12px;color:#9ca3af}
    .google-wrap{display:flex;justify-content:center}
  </style>
</head>

<body>
  <div class="container">
    <h2>تسجيل الدخول</h2>

    <div id="msg" class="message"></div>

    <div class="input-box" id="userBox">
      <i class="ri-user-3-line base-icon"></i>
      <input id="username" type="text" placeholder="اسم المستخدم" autocomplete="username" required>
      <div class="actions"><span class="state-icon"></span></div>
    </div>

    <div class="input-box" id="passBox">
      <i class="ri-lock-password-line base-icon"></i>
      <input id="password" type="password" placeholder="كلمة المرور" autocomplete="current-password" required>
      <div class="actions">
        <button class="icon-btn" id="togglePass" type="button"><i class="ri-eye-line"></i></button>
        <span class="state-icon"></span>
      </div>
    </div>

    <div class="options">
      <label><input id="remember" type="checkbox"> تذكرني</label>
      <a href="#" id="forgotLink">نسيت كلمة المرور؟</a>
    </div>

    <button class="main" id="loginBtn" onclick="login()">تسجيل الدخول</button>

    <div class="divider">أو</div>

    <!-- we render the Google button with JS to avoid callback-name issues [page:2] -->
    <div class="google-wrap"><div id="googleBtn"></div></div>
  </div>

<script>
  // ---------- Helpers ----------
  function showMsg(text, type='success'){
    const msg = document.getElementById('msg');
    msg.className = `message ${type}`;
    msg.textContent = text;
    msg.style.display = 'block';
  }

  function setFieldState(boxId, state){
    const box = document.getElementById(boxId);
    const stateEl = box.querySelector('.state-icon');
    box.classList.remove('valid','invalid');
    if(state === 'valid'){ box.classList.add('valid'); stateEl.innerHTML = '<i class="ri-check-line"></i>'; }
    else if(state === 'invalid'){ box.classList.add('invalid'); stateEl.innerHTML = '<i class="ri-close-line"></i>'; }
    else { stateEl.innerHTML = ''; }
  }

  // Origin debug (optional): ensure same origin between pages
  // console.log('origin:', location.origin);

  // ---------- Dynamic icons ----------
  const usernameEl = document.getElementById('username');
  const passwordEl = document.getElementById('password');

  usernameEl.addEventListener('input', () => {
    const v = usernameEl.value.trim();
    if(!v) return setFieldState('userBox','none');
    setFieldState('userBox', v.length >= 3 ? 'valid':'invalid');
  });

  passwordEl.addEventListener('input', () => {
    const v = passwordEl.value;
    if(!v) return setFieldState('passBox','none');
    setFieldState('passBox', v.length >= 6 ? 'valid':'invalid');
  });

  document.getElementById('togglePass').addEventListener('click', () => {
    const isPass = passwordEl.type === 'password';
    passwordEl.type = isPass ? 'text' : 'password';
    document.getElementById('togglePass').innerHTML = isPass ? '<i class="ri-eye-off-line"></i>' : '<i class="ri-eye-line"></i>';
  });

  document.getElementById('forgotLink').addEventListener('click', (e) => {
    e.preventDefault();
    showMsg('سيتم إضافة صفحة استرجاع كلمة المرور قريباً', 'success');
  });

  // ---------- Local login (demo) ----------
  function login(){
    const username = usernameEl.value.trim();
    const password = passwordEl.value;
    const remember = document.getElementById('remember').checked;

    if(!username || !password) return showMsg('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
    if(username.length < 3) return showMsg('اسم المستخدم يجب أن يكون 3 أحرف على الأقل', 'error');

    let users = [];
    try{ users = JSON.parse(localStorage.getItem('users') || '[]'); }catch(e){}
    const user = users.find(u => u.username === username && u.password === password);

    if(!user) return showMsg('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');

    localStorage.setItem('user', JSON.stringify({
      provider:'local',
      loggedIn:true,
      id: user.id || Date.now(),
      username: user.username,
      email: user.email || '',
      lastLogin: Date.now()
    }));

    if(remember){
      localStorage.setItem('rememberMe', JSON.stringify({ username:user.username, expires: Date.now() + 30*24*60*60*1000 }));
    } else {
      localStorage.removeItem('rememberMe');
    }

    const fromPage = sessionStorage.getItem('loginFrom') || 'index.html';
    window.location.href = fromPage;
  }

  // ---------- Google Sign-In ----------
  // GIS returns a JWT in response.credential; decode to get name/email/picture/sub (client display only). [page:1]
  function decodeJwtResponse(token) {
    let base64Url = token.split('.')[1];
    let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c){
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  function handleCredentialResponse(response) {
    try{
      const idToken = response && response.credential; // JWT [page:1]
      if(!idToken) return showMsg('تعذر استلام بيانات Google', 'error');

      const payload = decodeJwtResponse(idToken);

      localStorage.setItem('user', JSON.stringify({
        provider:'google',
        loggedIn:true,
        id: payload.sub || Date.now(),     // sub is recommended unique id [page:1]
        name: payload.name || '',
        email: payload.email || '',
        picture: payload.picture || '',
        idToken,
        lastLogin: Date.now()
      }));

      const fromPage = sessionStorage.getItem('loginFrom') || 'index.html';
      window.location.href = fromPage;
    } catch(e){
      showMsg('حدث خطأ أثناء تسجيل الدخول عبر Google', 'error');
    }
  }

  // Initialize + render button after library loads [page:2]
  window.addEventListener('load', () => {
    // rememberMe preload
    const rememberData = localStorage.getItem("rememberMe");
    if(rememberData) {
      try {
        const data = JSON.parse(rememberData);
        if(data.expires > Date.now()) {
          usernameEl.value = data.username || '';
          document.getElementById("remember").checked = true;
          usernameEl.dispatchEvent(new Event('input'));
        } else {
          localStorage.removeItem("rememberMe");
        }
      } catch(e) {
        localStorage.removeItem("rememberMe");
      }
    }

    // IMPORTANT: google.accounts.id must exist (library loaded)
    if(!window.google || !google.accounts || !google.accounts.id) {
      return showMsg('Google library لم تُحمّل. تأكد من الإنترنت ومن عدم حجب accounts.google.com', 'error');
    }

    google.accounts.id.initialize({
      client_id: "169941841275-n5h6h3bqa3ck0lll8dgd194uqb68b5jv.apps.googleusercontent.com",
      callback: handleCredentialResponse
    }); // initialize [page:2]

    google.accounts.id.renderButton(
      document.getElementById("googleBtn"),
      { theme: "outline", size: "large", shape: "pill", text: "signin_with" }
    ); // renderButton [page:2]
  });

  document.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') login();
  });
</script>
</body>
</html>
