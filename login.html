<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تسجيل الدخول</title>

  <link rel="icon" type="image/png" href="images/ofouq-logo.jpeg" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Tajawal',sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
      background: linear-gradient(135deg,#f5f7fb 0%,#e2e8f0 100%);
    }
    .container{
      width:100%;
      max-width:420px;
      background:#fff;
      border:1px solid rgba(148,163,184,.25);
      border-radius:18px;
      padding:26px;
      box-shadow: 0 18px 55px rgba(2, 6, 23, .12);
    }
    h2{margin:6px 0 10px;color:#0a4f5f;font-weight:800;font-size:26px}
    .subtitle{margin-bottom:16px;color:#64748b;font-size:13px;line-height:1.7}

    .message{
      display:none;
      margin-bottom:14px;
      padding:12px 16px;
      font-size:14px;
      border-radius:12px;
      font-weight:600;
      text-align:right;
    }
    .message.success{background:#10b981;color:#fff}
    .message.error{background:#ef4444;color:#fff}

    .input-box{position:relative;margin-bottom:14px}
    .base-icon{
      position:absolute;left:16px;top:50%;
      transform:translateY(-50%);
      font-size:18px;color:#94a3b8;
      pointer-events:none;
    }
    .input-box input{
      width:100%;
      padding:14px 16px 14px 48px;
      border:2px solid #e5e7eb;
      border-radius:14px;
      background:#f8fafc;
      outline:none;
      font-family:'Tajawal',sans-serif;
      font-size:15px;
    }
    .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0 16px;font-size:14px;color:#64748b;gap:10px}
    .row a{color:#0aa2ca;text-decoration:none;font-weight:700}

    button{
      width:100%;
      padding:14px;
      border:none;
      border-radius:14px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      font-family:'Tajawal',sans-serif;
    }
    .login-btn{
      background: linear-gradient(135deg,#0aa2ca,#078fa8);
      color:#fff;
    }
    .login-btn:disabled{opacity:.65;cursor:not-allowed}
  </style>
</head>

<body>
  <div class="container">
    <h2>تسجيل الدخول</h2>
    <div class="subtitle">سجّل دخولك بحساب Firebase (Email/Password).</div>

    <div id="msg" class="message"></div>

    <div class="input-box">
      <i class="ri-mail-line base-icon"></i>
      <input id="email" type="email" placeholder="البريد الإلكتروني" autocomplete="email" required>
    </div>

    <div class="input-box">
      <i class="ri-lock-password-line base-icon"></i>
      <input id="password" type="password" placeholder="كلمة المرور" autocomplete="current-password" required>
    </div>

    <div class="row">
      <label><input id="remember" type="checkbox"> تذكرني</label>
      <a href="#" id="forgotLink">نسيت كلمة المرور؟</a>
    </div>

    <button class="login-btn" id="loginBtn" type="button">
      <span id="loginText">تسجيل الدخول</span>
      <span id="loginSpinner" style="display:none;">جاري...</span>
    </button>
  </div>

  <script type="module">
    import { auth } from "./firebase-init.js";
    import {
      signInWithEmailAndPassword,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const rememberEl = document.getElementById("remember");
    const btn = document.getElementById("loginBtn");

    function showMsg(text, type="success"){
      const msg = document.getElementById("msg");
      msg.className = "message " + type;
      msg.textContent = text;
      msg.style.display = "block";
      if(type === "success") setTimeout(() => (msg.style.display = "none"), 2200);
    }

    function setLoading(v){
      btn.disabled = v;
      document.getElementById("loginText").style.display = v ? "none" : "inline";
      document.getElementById("loginSpinner").style.display = v ? "inline" : "none";
    }

    async function doLogin(){
      const email = emailEl.value.trim();
      const password = passEl.value;

      if(!email || !password){
        return showMsg("أدخل البريد الإلكتروني وكلمة المرور.", "error");
      }

      setLoading(true);

      try{
        // تذكرني => Local persistence، غير ذلك => Session persistence
        await setPersistence(auth, rememberEl.checked ? browserLocalPersistence : browserSessionPersistence);

        const cred = await signInWithEmailAndPassword(auth, email, password);

        localStorage.setItem("user", JSON.stringify({
          provider: "firebase",
          loggedIn: true,
          uid: cred.user.uid,
          email: cred.user.email || email,
          lastLogin: Date.now()
        }));

        const fromPage = sessionStorage.getItem("loginFrom") || "index.html";
        window.location.href = fromPage;

      } catch (e){
        showMsg("تعذر تسجيل الدخول: " + (e?.message || ""), "error");
        setLoading(false);
      }
    }

    btn.addEventListener("click", doLogin);

    document.addEventListener("keydown", (e) => {
      if(e.key === "Enter") doLogin();
    });

    document.getElementById("forgotLink").addEventListener("click", async (e) => {
      e.preventDefault();
      const email = emailEl.value.trim();
      if(!email) return showMsg("اكتب بريدك أولاً ثم اضغط نسيت كلمة المرور.", "error");

      try{
        await sendPasswordResetEmail(auth, email);
        showMsg("تم إرسال رابط استرجاع كلمة المرور إلى بريدك.", "success");
      } catch (err){
        showMsg("تعذر إرسال رابط الاسترجاع: " + (err?.message || ""), "error");
      }
    });
  </script>
</body>
</html>
